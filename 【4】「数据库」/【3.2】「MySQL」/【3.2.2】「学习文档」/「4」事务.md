## 一、什么是事务？

```
一个事务其实就是一个完整的业务逻辑，是一个最小的工作单元。
不可再分。
```

```
完整的业务逻辑：
	1）假设转账，从A账户向B账户中转账10000.
	2）将A账户的钱减去10000（update语句）
	3）将B账户的钱加上10000（update语句）
这就是一个完整的业务逻辑。

以上的操作是一个最小的工作单元，要么同时成功，要么同时失败，不可再分。
这两个update语句要求必须同时成功或者同时失败，这样才能保证钱是正确的。
```

## 二、事务本身

```
1. 只有DML语句才有事务一说，insert、update、delete。
	因为只有以上的三个语句是数据库表中数据进行增、删、改的。
	只要你的操作一旦涉及到数据的增、删、改，那么就一定要考虑安全问题。
	
2. 本质上，一个事务其实就是多条DML语句同时成功，或者同时失败。
```

## 三、事务是如何做到多条DML语句同时成功或失败呢？

```
InnoDB存储引擎：提供一组用来记录事务性活动的日志文件

例：
	事务开启了：
	insert
	insert
	insert
	delete
	update
	update
	事务结束了！
	
在事务的执行过程中，每一条DML的操作都会记录到“事务性活动的日志文件”
```

## 四、提交事务 & 回滚事务

```
**提交事务:**
	清空事务性活动的日志文件，将数据全部彻底持久化道数据库表中。
	提交事务标志着，事务的结束。并且是一种全部成功的结束。
	
	commit;

**回滚事务：**
	将之前所有的DML操作全部撤销，并且清空事务性活动的日志文件。
	回滚事务标志着，事务的结束。并且是一种全部失败的结束。
	
	rollback; -- 回滚永远都是只能回滚道上一次的提交点！
```

```
MySQL默认情况下是支持自动提交事务的。每执行一条DML语句，则提交一次！

这种自动提交实际上是不符合我们的开发习惯，因为一个业务通常是需要多条DML语句共同执行才能完成的，为了保证数据的安全，必须要求同时成功之后再提交，所以不能执行一条就提交一条。
```

```sql
-- 开启事务命令：
start transaction;
```

## 五、事务的特性

```
A：原子性
	说明事务是最小的工作单元，不可再分。
C：一致性
	所有事务要求，在同一个事务当中，所有操作必须同时成功，或者同时失败，以保证数据的一致性。
I：隔离性
	A事务和B事务之间具有一定的隔离。
D：持久性
	事务最终结束的一个保障。事务提交，就相当于将没有保存到硬盘上的数据保存到硬盘上！
```

```
**隔离级别：**
	1）读未提交
		（1）事务A可以读取到事务B未提交的数据。
		（2）这种隔离级别存在的问题就是：
				脏读现象（Dirty Read）
				
	2）读已提交
		（1）事务A只能读取到事务B提交之后的数据。
		（2）解决了脏读现象。
		（3）这种隔离级别存在问题：不可重复读取数据
				在事务开启之后，第一次读到的数据是3条，当前事务还没有结束，可能第二次再读取的时候，读到的数据是4条，3不等于4称为不可重复				读取。
		（4）这种隔离级别是比较真实的数据，每一次读到的数据是绝对的真实。
		
	3）可重复读（repeatable read）《提交之后也读不到，永远读取的都是刚开启事务时的数据》
		（1）事务A开启之后，不管是多久，每一次在事务A中读取到的数据都是一致的。即使事务B将数据已经修改，并且提交了，事务A读取到的数据				 还是没有发生改变。
		（2）解决了不可重复读取数据
		（3）存在的问题：
				可能出现幻影读
				每一次读取到的数据都是幻象，不够真实！
				
	4）序列化/串行化（serializable）最高的隔离级别
		（1）这是最高隔离级别，效率最低。解决了所有的问题。
		（2）这种隔离级别表示事务排队，不能并发！
		（3）synchronized，线程同步（事务同步）
		（4）每一次读取到的数据都是最真实的，并且效率是最低的。
```

```mysql
-- 查看当前隔离级别
select @@tx_isolation;
select @@session.tx_isolation;

-- 查看全局的隔离级别
select @@global.tx_isolation;

-- 设置会话级隔离级别为READ COMMITTED
set transaction isolation level read committed;

-- 设置全局级隔离级别为READ COMMITTED
set global transaction isolation level read committed;
```

![截屏2021-12-05 下午2.12.38](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/202112062243325.png)