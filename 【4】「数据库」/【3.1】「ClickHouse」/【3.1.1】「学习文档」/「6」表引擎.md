

## 一、Log系列引擎

![截屏2021-11-08 下午11.22.13](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-08%20%E4%B8%8B%E5%8D%8811.22.13.png?token=AWS37JLTVUNFCFDD3SHVLKLBTIG2K)

### 1. TinyLog

![截屏2021-11-08 下午11.25.29](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-08%20%E4%B8%8B%E5%8D%8811.25.29.png?token=AWS37JLQH4VFRXP72BMNU7TBTIG2O)

![截屏2021-11-08 下午11.26.42](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-08%20%E4%B8%8B%E5%8D%8811.26.42.png?token=AWS37JMKQZSJ26ZRV7XOK5LBTIG22)

![截屏2021-11-08 下午11.28.30](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-08%20%E4%B8%8B%E5%8D%8811.28.30.png?token=AWS37JNODKE4UUBDIS23ARTBTIG3Q)

### 2.Log

![截屏2021-11-08 下午11.30.23](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-08%20%E4%B8%8B%E5%8D%8811.30.23.png?token=AWS37JPK3S7VWT2UPWXCZA3BTIG4C)

![截屏2021-11-08 下午11.31.38](/Users/peiyang/Library/Application Support/typora-user-images/截屏2021-11-08 下午11.31.38.png)

![截屏2021-11-08 下午11.32.07](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-08%20%E4%B8%8B%E5%8D%8811.32.07.png?token=AWS37JOXNDD4TVJMBVQY73LBTIG4I)

### 3. StripeLog

![截屏2021-11-08 下午11.33.13](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-08%20%E4%B8%8B%E5%8D%8811.33.13.png?token=AWS37JMY3YGHPWFVNOASVK3BTIG5E)

![截屏2021-11-08 下午11.33.23](/Users/peiyang/Library/Application Support/typora-user-images/截屏2021-11-08 下午11.33.23.png)

![截屏2021-11-08 下午11.33.33](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-08%20%E4%B8%8B%E5%8D%8811.33.33.png?token=AWS37JOJANEG7J6W264Z753BTIG5S)

## 二、MergeTree

![截屏2021-11-08 下午11.37.02](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-08%20%E4%B8%8B%E5%8D%8811.37.02.png?token=AWS37JLEDMHBEQNVCSRWUADBTIG5Y)

![截屏2021-11-08 下午11.37.56](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-08%20%E4%B8%8B%E5%8D%8811.37.56.png?token=AWS37JLZSESRC6H4PRX2PS3BTIG5Y)

### 1）MergeTree

<font color='red'>主键不负责去重，主键负责帮助索引</font>

![截屏2021-11-08 下午7.33.54](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-08%20%E4%B8%8B%E5%8D%887.33.54.png?token=AWS37JN6BG4WL7JZECFTBULBTIG6I)

```
## 索引力度
SETTING index_granularity = 8192;

## 分区规则
如果是按照数字，则是数字
如果是String，则是hash
```

**--底层存储**

![截屏2021-11-08 下午11.41.23](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-08%20%E4%B8%8B%E5%8D%8811.41.23.png?token=AWS37JOBS2WA645FDX6BDW3BTIG7A)

```
optimize table ----- final;
```

![截屏2021-11-08 下午11.47.58](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-08%20%E4%B8%8B%E5%8D%8811.47.58.png?token=AWS37JKXJPAKV36UMQMEU5TBTIHAE)

![截屏2021-11-08 下午11.53.12](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-08%20%E4%B8%8B%E5%8D%8811.53.12.png?token=AWS37JNVAX4RBLCSVKNYQDDBTIHAA)

![截屏2021-11-08 下午11.54.09](/Users/peiyang/Library/Application Support/typora-user-images/截屏2021-11-08 下午11.54.09.png)

![截屏2021-11-08 下午11.57.14](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-08%20%E4%B8%8B%E5%8D%8811.57.14.png?token=AWS37JIH7EYRJQUF5ZLNEODBTIHAO)

![截屏2021-11-08 下午11.58.27](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-08%20%E4%B8%8B%E5%8D%8811.58.27.png?token=AWS37JOGLGQNLVR5PYTNLOLBTIHAQ)

**-- 其他参数**

![截屏2021-11-08 下午11.49.44](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-08%20%E4%B8%8B%E5%8D%8811.49.44.png?token=AWS37JNEKJAXB2DU5U75EPTBTIHBA)

![截屏2021-11-08 下午11.50.04](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-08%20%E4%B8%8B%E5%8D%8811.50.04.png?token=AWS37JK53J6GHCJP5IQ37JTBTIHBW)

![截屏2021-11-08 下午11.50.39](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-08%20%E4%B8%8B%E5%8D%8811.50.39.png?token=AWS37JNFOGJQGMBL3BA5BPTBTIHCA)

### 2）ReplacingMergeTree

![截屏2021-11-09 上午12.05.56](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.11.30.png?token=AWS37JKN3667IPPFBPJIZLDBTIHCG)

```
## 使用多线程插入的时候，新老数据进行折叠合并，删除的时候，删了新的留下了老的
（除了主键以外可能会发生变化的字段）

## 一个数据块最大是8192行，数据同一时间插入会被放到同一数据块中，触发合并，会按照分区将多个数据块进行合并
```

![截屏2021-11-09 上午12.21.30](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.21.30.png?token=AWS37JOT5RDRTDCYOCRXGV3BTIHCS)

### 3） CollapsingMergeTree

![截屏2021-11-09 上午12.25.44](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.25.44.png?token=AWS37JPXHWFXCHLGUAOXHKLBTIHC2)

![截屏2021-11-09 上午12.29.50](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.29.50.png?token=AWS37JOFJMZ4E4BWSN77OPDBTIHDA)

![截屏2021-11-09 上午12.34.11](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.34.11.png?token=AWS37JITCHUSU4YU545HTO3BTIHDG)

![截屏2021-11-09 上午12.34.31](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.34.31.png?token=AWS37JJ5QADJFD2BN4D7VULBTIHDI) 

### 4）VersionedCollapsingMergeTree

![截屏2021-11-09 上午12.36.29](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.36.29.png?token=AWS37JIZNSLOVYXHUQIPXKLBTIHDY)

![截屏2021-11-09 上午12.38.02](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.38.02.png?token=AWS37JOND5SACVSZFOXSWBDBTIHD6)

![截屏2021-11-09 上午12.38.29](/Users/peiyang/Library/Application Support/typora-user-images/截屏2021-11-09 上午12.38.29.png)



### 5）SummingMergeTree

![截屏2021-11-09 上午12.39.08](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.39.08.png?token=AWS37JKUWCKQ2VH2PSU7VPTBTIHEM)

![截屏2021-11-09 上午12.39.39](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.39.39.png?token=AWS37JMNSP33Q7T6MN4MGP3BTIHEU)

![截屏2021-11-09 上午12.40.03](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.40.03.png?token=AWS37JLAOGEJDP7OF3Q45LDBTIHFK)

![截屏2021-11-09 上午12.40.21](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.40.21.png?token=AWS37JL3Y7EJJIJUZY6DHA3BTIHFA)

![截屏2021-11-09 上午12.41.56](/Users/peiyang/Library/Application Support/typora-user-images/截屏2021-11-09 上午12.41.56.png)

![截屏2021-11-09 上午12.42.30](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.42.30.png?token=AWS37JILRCZAETJ4YTDGDRTBTIHFO)

![截屏2021-11-09 上午12.42.54](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.42.54.png?token=AWS37JK6M4WIULMCRHWTNGDBTIHGG)

![截屏2021-11-09 上午12.43.08](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.43.08.png?token=AWS37JNQWHTIY2C7LJQPBM3BTIHGS)

### 6）AggregatingMergeTree

![截屏2021-11-09 上午12.43.46](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.43.46.png?token=AWS37JOAX7EKRIOB6GSDQEDBTIHGY)

![截屏2021-11-09 上午12.43.58](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.43.58.png?token=AWS37JIPBGHNXR6AAB3RSR3BTIHG6) ![截屏2021-11-09 上午12.50.05](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.50.05.png?token=AWS37JL3CZYO4SYCZULHUPTBTIHIM)

![截屏2021-11-09 上午12.51.40](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.51.40.png?token=AWS37JKYIYTG3GDWZOB5MVDBTIHIO)

![截屏2021-11-09 上午12.51.55](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.51.55.png?token=AWS37JJSLB24AOXAYD7WEIDBTIHIY)

![截屏2021-11-09 上午12.52.13](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.52.13.png?token=AWS37JP4PL6DZHF4U7LSWELBTIHI2)

![截屏2021-11-09 上午12.52.35](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.52.35.png?token=AWS37JIGVYJKXA4IOWYSFJ3BTIHI6)

![截屏2021-11-09 上午12.55.23](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.55.23.png?token=AWS37JMK6MIHXWZABOLPLLTBTIHJQ)

<font color='red'>使用物化视图同步聚合数据</font>

![截屏2021-11-09 上午12.56.38](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.56.38.png?token=AWS37JNSBTE5UWIYYFCTEY3BTIHNW)

![截屏2021-11-09 上午12.57.29](https://raw.githubusercontent.com/DataDevLPY/TyporaPicStore/main/img/%E6%88%AA%E5%B1%8F2021-11-09%20%E4%B8%8A%E5%8D%8812.57.29.png?token=AWS37JNCYJAV3PE65JVMBWTBTIHN2)



```
CREATE TABLE test.test_table_10
(
    `remark_1` Nullable(String),
    `remark_2` Nullable(String),
    `remark_3` Nullable(String),
    `hhhh` String
)
ENGINE = MergeTree
ORDER BY hhhh

insert into test.test_table_10 values ('a','b','c','hh'),('a','b','c','hh'),('a','b','c','hh');
insert into test.test_table_10 values ('a','b','c','hh');
insert into test.test_table_10 values ('a','b','c','hh');
insert into test.test_table_10 values ('a','b','c','hh');
insert into test.test_table_10 values ('a','b','c','hh');
insert into test.test_table_10 values ('a','b','c','hh');
insert into test.test_table_10 values ('a','b','c','hh');
insert into test.test_table_10 values ('a','b','c','hh');
insert into test.test_table_10 values ('a','b','c','hh');
insert into test.test_table_10 values ('a','b','c','hh');
insert into test.test_table_10 values ('a','b','c','hh');
insert into test.test_table_10 values ('a','b','c','hh');
insert into test.test_table_10 values ('a','b','c','hh');
insert into test.test_table_10 values ('a','b','c','hh');
insert into test.test_table_10 values ('a','b','c','hh');
```











